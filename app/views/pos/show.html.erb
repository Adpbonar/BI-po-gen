<h1>PO <%= @po.po_number %>: <%= @po.title %></h1>
<p style="text-transform: uppercase;"><b>Status: <%= @po.status %></b></p>
<p>Service: <%= @po.service_type %></p>
<p>Approximate completion time: <%= @po.duration %><br />
<small class="highlight">From <%= read_date(@po.start_date) %> to <%= read_date(@po.end_date) %></small></p>
<p>PO <%=sanitize @po.issued_by %></p>
<% if @po.description.present? %>
    <div class="top-bottom-spacing">
    <p><b>Description</b></p>
        <%= @po.description %>
    </div>
<% end %>
<div class="top-bottom-spacing">
    <h2>Po Participants</h2>
    <div class="top-bottom-spacing">
        <p><span class="bold">Learning coordinator:</span> <%= @po.show_coordinator %></p>
        
        <p><span class="bold">PO initiator:</span> <%= @po.show_found %></p>
    </div>
    <% @po_users.group_by(&:type_of).each do |type_of, users| %>
        <h3><%= type_of %>s</h3>
        <% users.each do |user| %>
            <div>
                <span class="upcase"><%= user.participant.name %> (<%= type_of %>)</span>
                <% if type_of == 'Associate' && ! @po.locked %>
                    <% if @po.learning_coordinator.blank? %>
                        <%= content_tag :button, class: 'btn btn-success', data: { reflex: "click->PartitipantReflex#coordinator", id: @po.id, coordinator: user.participant_id } do %>
                            make <%= initiator(user.participant.name) %> coordinator
                        <% end %>
                    <% elsif @po.learning_coordinator == user.participant_id %>
                        <%= content_tag :button, class: 'btn btn-danger', data: { reflex: "click->PartitipantReflex#remove_coordinator", id: @po.id } do %>
                            demote <%= initiator(user.participant.name) %> as coordinator
                        <% end %>
                    <% end %>
                <% end %>
            </div>
        <% end %>
    <% end %>
</div>
<% if @po.show_participant == true %>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <div id="ethics" class="overlay">
        <div class="overlay-content">
            <div id="ethicsClose" class="closeContainter">
                <%= content_tag :span, alt: "close", role: "button", title: "Close", class: "closebtn", data: { reflex: "click->PartitipantReflex#hide", id: @po.id } do %>
                    <div class="closeDesign">Ã—</div>
                <% end %>
            </div>
            <div class="default">
            <h2 class="center">Add Participants</h2>
            <div class="top-bottom-spacing">
            <% @users.group_by(&:type_of).each do |type_of, participants| %>
                <h3 class="center"><%= type_of %>s</h3>
                    <% participants.each do |participant| %>
                            <%= content_tag :div, class: 'saved-item', data: { reflex: "click->PartitipantReflex#add", id: participant.id, po: @po.id }  do %>
                                <%= participant.name %>
                            <% end %>
                            <center>
                            <% if type_of == 'Associate' %>
                                <% if @po.found.blank? %>
                                    <%= content_tag :button, class: 'btn btn-success', data: { reflex: "click->PartitipantReflex#initiator", id: @po.id, coordinator: participant.id } do %>
                                        Make <%= initiator(participant.name) %> PO initiator
                                    <% end %>
                                <% elsif @po.found == participant.id %>
                                    <%= content_tag :button, class: 'btn btn-danger', data: { reflex: "click->PartitipantReflex#remove_initiator", id: @po.id } do %>
                                        demote <%= initiator(participant.name) %> from PO initiator role
                                    <% end %>
                                <% end %>
                            <% end %>
                        </center>
                    <% end %>
                <% end %>
            </div>
            </div>
        </div>
    </div>
<% end %>
<% unless @po.locked %>
    <%= content_tag :div, id:"eLink", role: "button", alt: "Add Participants", class: "ethicsLink", data: { reflex: "click->PartitipantReflex#show", id: @po.id } do %>
        Add Participants
    <% end %>
<% end %>

<h2>Installments</h2>
<% if @po.installments.count == @po.number_of_installments %>
<div class="upcase">Number of installments: <%= @po.number_of_installments %> (<%= @po.initilize_default_installments %>)  |  PO client currency: <%= show_currency(@po) %>  |  PO value: <%= @po.currency.html_safe.to_s + number_to_currency(@po.statements.first.subtotal).split("$").last %></div>
<% end %>
<% @po.installments.order([:id]).each_with_index do |installment, index| %>
    <% if installment.due_date.present? %>
        <div class="top-bottom-spacing">Installment <%= index + 1 %>: <span class="highlight"><%= read_date(installment.due_date) %></span>  @ <%= installment.percentage %>%</div><div><%= link_to 'Change due date', edit_installment_path(installment), class: 'btn btn-info' %></div>
    <% else %>
    <div class="top-bottom-spacing">Installment <%= index + 1 %>: <%= link_to 'No Due Date set for installment', edit_installment_path(installment), class: 'btn btn-info' %> @ <%= installment.percentage %>%</div>
    <% end %>
<% end %>
<h2>Statements</h2>
<ul>
<% @po.statements.each do |statement|%> 
    <% if statement.type == 'ClientStatement' %>
        <li><%= link_to "client statement".capitalize, statement_path(statement), class: 'default-link' %></li>
    <% elsif statement.type == 'GeneralStatement' %>
         <li><%= link_to "general statement".capitalize, statement_path(statement), class: 'default-link' %></li>
    <% else %>
        <li><%= link_to "associate statement".capitalize, statement_path(statement), class: 'default-link' %></li>
    <% end %>
<% end %> 
</ul>
<% unless @po.locked %>
    <center><button id="show-button" class="btn btn-warning">Adjust installments</button><button id="hide-button" class="no-show btn btn-secondary">I changed my mind...</button></center>
    <div class="top-bottom-spacing no-show" id="adjust-installments">
        <h2>Adjust the number and percentage of installments</h2>
        <%= text_field_tag 'set-installment' %>  
        <small>Adjust number and percentage of installments using the following format "30 30 30 10", where the number is the percentage and the quanity of numbers is the amount of installments.  <span class="highlight"><br /><b>Note:</b> that decimals are not accepted and that the total of the installment percentages must equal 100.</span></small>
        <div class="top-bottom-spacing"><%= button_tag 'submit changes', type: "text", pattern: "([0-9]+.{0,1}[0-9]*,{0,1})*[0-9]",  id: "installment-submit", class: 'btn btn-secondary', data: { reflex: "click->InstallmentReflex#change", id: @po.id, installments: "" } %></div>
        </div>
    </div>
<% end %>
    <%= link_to 'Edit', edit_po_path(@po), class: 'btn btn-warning' %>
    <%= link_to 'Back', pos_path, class: 'btn btn-secondary' %>

    <script>
        var installmentInput = document.getElementById("set-installment");
        $('#set-installment').bind({
            keydown: function (e) {
                if (e.shiftKey === true) {
                    if (e.which == 9) {
                        return true;
                    }
                    return false;
                }
                if (e.which > 57) {
                    return false;
                }
                if (e.which == 32) {
                    return true;
                }
                return true;
            }
        });
    </script>