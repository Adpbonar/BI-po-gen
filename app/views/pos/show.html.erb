<div>
  <h1>PO <%= @po.po_number %>: <%= @po.title %></h1>
  <p style="text-transform: uppercase;"><b>Status: <%= @po.status %></b></p>
  <p>Service: <%= @po.service_type %></p>
  <p>Approximate completion time: <%= @po.duration %><br />
    <small class="highlight">From <%= read_date(@po.start_date) %> to <%= read_date(@po.end_date) %></small></p>
  <p>PO <%=sanitize @po.issued_by %></p>
  <% if @po.description.present? %>
    <div class="top-bottom-spacing">
      <p><b>Description</b></p>
      <%= @po.description %>
    </div>
  <% end %>
  <div>
    <div class="top-bottom-spacing change">
      <h2>Po Participants</h2>
      <div class="top-bottom-spacing">
        <p><span class="bold">Learning coordinator:</span> <%= @po.show_coordinator %></p>
        <p><span class="bold">PO initiator:</span> <%= @po.show_found %></p>
      </div>
      <% @po_users.group_by(&:type_of).each do |type_of, users| %>
        <h3><%= type_of %>s</h3>
        <% users.each do |user| %>
          <div>
            <span class="upcase"><%= user.participant.name %> (<%= type_of %>)</span>
            <% if type_of == 'Associate' && ! @po.locked %>
              <div>
                <% if @po.learning_coordinator == user.participant_id %>
                  <%= content_tag :button, id: 'remove_coordinator', class: 'btn btn-danger', data: { reflex: "click->PartitipantReflex#remove_coordinator", id: @po.id } do %>
                    demote <%= user.participant.member_name %> as coordinator
                  <% end %>
                <% else %>
                  <% if @po.learning_coordinator == nil %>
                    <div>
                      <%= content_tag :button, class: 'btn btn-success', id: 'add_coordinator', data: { reflex: "click->PartitipantReflex#coordinator", id: @po.id, coordinator: user.participant_id } do %>
                        make <%= user.participant.member_name %> coordinator
                      <% end %>
                    </div>
                  <% end %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
  <h2>Installments</h2>
  <table style="width: 100%; margin: 1em;">
    <tbody>
      <tr>
        <td>
          <% if @po.installments.count == @po.number_of_installments %>
            <div class="upcase">Number of installments: <%= @po.number_of_installments %>
              (<%= @po.initilize_default_installments %>) | PO client currency: <%= show_currency(@po) %> | PO value:
              <%= @po.currency.html_safe.to_s + number_to_currency(@po.statements.first.subtotal).split("$").last %></div>
          <% end %>
          <% @po.installments.order([:id]).each_with_index do |installment, index| %>
            <% if installment.due_date.present? %>
              <div class="top-bottom-spacing">Installment <%= index + 1 %>: <span
            class="highlight"><%= read_date(installment.due_date) %></span> @ <%= installment.percentage %>%</div>
              <div><%= link_to 'Change due date', edit_installment_path(installment), class: 'btn btn-info' %></div>
            <% else %>
              <div class="top-bottom-spacing">Installment <%= index + 1 %>:
                <%= link_to 'No Due Date set for installment', edit_installment_path(installment), class: 'btn btn-info' %> @
                <%= installment.percentage %>%</div>
            <% end %>
          <% end %>
        </td>
        <td>
          <div data-reflex-permanent>
            <div id="loadingChart" class="center"></div>
            <div id="installmentChart">
              <%= pie_chart @pdf_chart_data, donut: true, legend: true, title: "Installment Percentages"  %>
            </div>  
          </div>
        </td>
      </tr>
    </tbody>
  </table>
  <h2>Statements</h2>
  <ul>
    <% @po.statements.each do |statement|%>
      <% unless statement.no_general %>
        <% if statement.type == 'ClientStatement' %>
          <li><%= link_to "client statement".capitalize, statement_path(statement), class: 'default-link' %></li>
        <% elsif statement.type == 'GeneralStatement' %>
          <li><%= link_to "edit statement".capitalize, statement_path(statement), class: 'default-link' %></li>
        <% else %>
          <li><%= link_to "associate statement".capitalize, statement_path(statement), class: 'default-link' %></li>
        <% end %>
      <% end %>
    <% end %>
  </ul>
  <% unless @po.locked %>
    <center><button id="show-button" class="btn btn-warning">Adjust installments</button><button id="hide-button"
            class="no-show btn btn-secondary">I changed my mind...</button></center>
    <div class="top-bottom-spacing no-show" id="adjust-installments">
      <h2>Adjust the number and percentage of installments</h2>
      <%= text_field_tag 'set-installment' %>
      <small>Adjust number and percentage of installments using the following format "30 30 30 10", where the number
        is the percentage and the quanity of numbers is the amount of installments. <span
                class="highlight"><br />
          <b>Note:</b> that decimals are not accepted and that the total of the
          installment percentages must equal 100.</span></small>
      <div class="top-bottom-spacing">
        <%= button_tag 'submit changes', type: "text", pattern: "([0-9]+.{0,1}[0-9]*,{0,1})*[0-9]",  id: "installment-submit", class: 'btn btn-secondary', data: { reflex: "click->InstallmentReflex#change", id: @po.id, installments: "" } %>
      </div>
    </div>
  <% end %>
  <%= link_to 'Edit', edit_po_path(@po), class: 'btn btn-warning' %>
  <%= link_to 'Back', pos_path, class: 'btn btn-secondary' %>
  <% unless @po.statements.count > 1 %>
    <div id="addContacts"></div>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <div id="ethics" class="overlay">
      <div class="overlay-content">
        <div id="ethicsClose" class="closeContainter">
        </div>
        <div class="default">
          <h2 class="center">Add Participants</h2>
          <div class="top-bottom-spacing">
            <% @users.group_by(&:type_of).each do |type_of, participants| %>
              <h3 id="<%= type_of %>" class="center"><%= type_of %>s <button id="<%= type_of %>-button"
                            class="contact-button btn-sm">Go to <%= type_switch(type_of) %>s</button></h3>
              <script>
                $("#<%= type_of %>-button").click(function () {
                    $('html, body').animate({
                        scrollTop: $("#<%= type_switch(type_of) %>").offset().top
                    }, 500);
                });
              </script>
              <div class="side-by-side smaller-side">
                <div class="center upcase">Lookup <%= type_of %> by the letter</div>
                <% participants.group_by(&:first_letter).sort.each do |first_letter| %>
                  <div class="contact-button" id="<%= type_of %>-button-<%= first_letter[0] %>">
                    <%= first_letter[0] %></div>
                  <script>
                    $("#<%= type_of%>-button-<%= first_letter[0] %>").click(function () {
                        $('html, body').animate({
                            scrollTop: $("#<%= type_of%>-<%= first_letter[0] %>").offset().top
                        }, 500);
                    });
                  </script>
                <% end %>
                <a href="#addContacts" class="contacts">
                  <div class="contact-button upcase backToTop" id="backToTop">
                    Top
                  </div>
                </a>
                <script>
                  $(".backToTop").click(function () {
                    setTimeout( function() { window.history.replaceState({}, document.title, window.location.href.split('#')[0]); }, 100 );
                  });
                </script>
              </div>
              <div class="side-by-side bigger-side">
                <% participants.group_by(&:first_letter).sort.each do |first_letter, participants| %>
                  <div class="align-right scroll-btn" id="<%= type_of %>-<%= first_letter %>"><b><%= first_letter %></b>
                  </div>
                  <script>
                    $("#<%= type_of%>-<%= first_letter[0] %>").click(function () {
                        $('html, body').animate({
                            scrollTop: $("#<%= type_of%>-<%= first_letter[0] %>").offset().top
                        }, 500);
                    });
                  </script>
                  <hr />
                  <div>
                    <% participants.sort.each do |participant| %>
                      <% if ! PoUser.where(po_id: @po.id, participant_id: participant.id).any? %>
                        <%= content_tag :div, class: 'saved-item', data: { reflex: "click->PartitipantReflex#add", id: participant.id, po: @po.id }  do %>
                          <%= participant.name %>
                        <% end %>
                      <% else %>
                        <p class="center upcase"> <%= type_of %> <strong><%= participant.name %></strong> has already been added to this PO. <%= button_tag class: "round-btn", data: { reflex: "click->PartitipantReflex#remove_participant", id: participant.po_users.where(po_id: @po.id).first.id, po: @po.id } do %>X<% end %></p>
                      <% end %>
                      <center>
                        <div>
                          <div class="change">
                            <% if type_of == 'Associate' %>
                              <div>
                                <% if @po.found.blank? %>
                                  <div>
                                    <%= content_tag :button, class: 'btn btn-success', data: { reflex: "click->PartitipantReflex#initiator", id: @po.id, coordinator: participant.id } do %>
                                      Make <%= participant.member_name %> PO initiator
                                    <% end %>
                                  </div>
                                <% elsif @po.found == participant.id %>
                                  <div>
                                    <%= content_tag :button, class: 'btn btn-danger', data: { reflex: "click->PartitipantReflex#remove_initiator", id: @po.id } do %>
                                      demote <%= participant.member_name %> from PO initiator role
                                    <% end %>
                                  </div>
                                <% end %>
                              </div>
                            <% end %>
                          </div>
                        </div>
                      </center>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% end %>
</div>
<script>
  var installmentInput = document.getElementById("set-installment");
  $('#set-installment').bind({
    keydown: function (e) {
      if (e.which >= 96 && e.which <= 105) {
          return true;
      }
      if (e.shiftKey === true) {
        if (e.which == 9) {
          return true;
        }
        return false;
      } 
      if (e.which > 57) {
        return false;
      }
      if (e.which == 32) {
        return true;
      }
      return true;
    }
  });
  $('#installment-submit').click(function() {
    document.getElementById("loadingChart").textContent = "Updating Installment Chart...";
    $("#installmentChart").hide();
    window.setTimeout(function () {
      window.location.reload();
    }, 3000);
  });
</script>
</div>
